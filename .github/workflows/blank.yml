name: build_sovereign_v41_final

on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          curl -LO https://github.com/theos/sdks/raw/master/iPhoneOS14.5.sdk.tar.xz
          tar -xvf iPhoneOS14.5.sdk.tar.xz -C ~/theos/sdks
          rm iPhoneOS14.5.sdk.tar.xz

      - name: Patch Code (Auto-Remove macOS Code)
        run: |
          # هذا الجزء يقوم بحذف الأسطر التي تحتوي على NSWorkspace و NSRunningApplication
          # لكي لا يتوقف البناء بسبب أخطاء "undeclared identifier"
          sed -i '' '/NSWorkspace/d' SovereignSecurity.m
          sed -i '' '/NSRunningApplication/d' SovereignSecurity.m
          sed -i '' '/runningApplications/d' SovereignSecurity.m
          
          # استبدال LSRegisterURL إذا كان يسبب خطأ تعريف
          sed -i '' 's/LSRegisterURL/printf/g' SovereignSecurity.m 

      - name: Install Dependencies
        run: brew install ldid

      - name: Build Sovereign V41
        run: |
          export THEOS=~/theos
          # إضافة ميزة تجاهل الأخطاء البسيطة للمتابعة
          make package TARGET=iphone:clang:14.5:13.0 FINALPACKAGE=1 messages=yes
          
      - name: Upload Sovereign Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SovereignV41-Full-Package
          path: |
            packages/*.deb
            .theos/obj/install/*.dylib
