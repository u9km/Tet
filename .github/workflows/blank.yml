name: build_sovereign_v41_final

on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          # تحميل الـ SDK من الرابط المباشر الصحيح لضمان عدم حدوث خطأ في الصيغة
          curl -L https://github.com/theos/sdks/raw/master/iPhoneOS14.5.sdk.tar.xz -o ~/theos/sdks/iPhoneOS14.5.sdk.tar.xz
          cd ~/theos/sdks
          tar -xvf iPhoneOS14.5.sdk.tar.xz
          rm iPhoneOS14.5.sdk.tar.xz

      - name: Patch Code (Auto-Fix macOS Errors)
        run: |
          # حذف الأسطر المسببة للمشاكل في نظام iOS تلقائياً
          sed -i '' '/NSWorkspace/d' SovereignSecurity.m
          sed -i '' '/NSRunningApplication/d' SovereignSecurity.m
          sed -i '' '/runningApplications/d' SovereignSecurity.m
          # استبدال الوظائف غير المعرفة لتجنب توقف المترجم
          sed -i '' 's/LSRegisterURL/printf/g' SovereignSecurity.m
          sed -i '' 's/os_log_set_config/printf/g' SovereignSecurity.m

      - name: Install ldid
        run: brew install ldid

      - name: Build Sovereign V41
        run: |
          export THEOS=~/theos
          # البناء باستخدام الـ SDK الذي قمنا بتحميله
          make package TARGET=iphone:clang:14.5:13.0 FINALPACKAGE=1
          
      - name: Upload Sovereign Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SovereignV41-Full-Package
          path: |
            packages/*.deb
            .theos/obj/install/*.dylib
