name: build_sovereign_v41_final

on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Theos
        run: |
          git clone --recursive https://github.com/theos/theos.git ~/theos
          mkdir -p ~/theos/sdks
          # تحميل SDK 14.5 من مصدر بديل ومستقر بصيغة zip
          curl -L "https://github.com/xybp888/iOS-SDKs/archive/refs/heads/master.zip" -o ~/theos/sdks/sdks.zip
          unzip -q ~/theos/sdks/sdks.zip -d ~/theos/sdks/
          # ترتيب المجلدات ليتعرف عليها Theos
          mv ~/theos/sdks/iOS-SDKs-master/*.sdk ~/theos/sdks/
          rm -rf ~/theos/sdks/sdks.zip ~/theos/sdks/iOS-SDKs-master

      - name: Patch Code (Auto-Fix macOS Errors)
        run: |
          # تنظيف الكود من شوائب الماك
          sed -i '' '/NSWorkspace/d' SovereignSecurity.m
          sed -i '' '/NSRunningApplication/d' SovereignSecurity.m
          sed -i '' '/runningApplications/d' SovereignSecurity.m
          sed -i '' 's/LSRegisterURL/printf/g' SovereignSecurity.m
          sed -i '' 's/os_log_set_config/printf/g' SovereignSecurity.m
          sed -i '' '/os_log_t/d' SovereignSecurity.m
          # حذف أي سطر يحاول استخدام المتغير app الذي كان يعتمد على NSRunningApplication
          sed -i '' '/app/d' SovereignSecurity.m

      - name: Install ldid
        run: brew install ldid

      - name: Build Sovereign V41
        run: |
          export THEOS=~/theos
          # تنفيذ البناء مع استهداف SDK 14.5 الذي تم فكه
          make package TARGET=iphone:clang:14.5:13.0 FINALPACKAGE=1
          
      - name: Upload Sovereign Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SovereignV41-Full-Package
          path: |
            packages/*.deb
            .theos/obj/install/*.dylib
